# 介绍

账号服务主要是完成，账号的注册，登录，注销等。以及登录态管理相关的能力（登录态校验，发放，多端登录，同端互踢等）

# 介绍系统怎么搭建的, 介绍一下里面用到的技术，分别在什么场景下面

系统使用 springboot 搭建的。

1. 远程服务调用用到了: double

2. 账号的存储和登录态的存储使用了： MySQL， redis

   1. mysql 主要是存储 账号数据，token 数据

   2. redis 存储 token数据； 分布式锁（注册手机号+appid 是唯一键不需要分布式锁。登陆场景同一个端mysql只会存一份token . 也不需要分布式锁。**忘记在哪用的分布式锁了**

      ）

3. 使用到了 sentinel 来完成对 redis和db,以及远程服务嗲用的熔断&限流 以及降级逻辑处理

4. rocketMQ： 账号注销的时候发送消息（事务消息）出去，用于其他业务根据他们的要求对该账号的其他业务信息进行处理。

# QPS 

20w  平均耗时 5m 一台机器差不多正常能接收 35000qps , 不过由于服务不是单一的只做 登录态校验，还有发放登录态处罚功能。还有因为使用到 本地缓存等功能。会涉及到内存问题。我们的机器有 16台机器。 这样也可以应对一些突发流量，QA压测后发现一台机器承担2w+的qps就是内存回到85+了. 

# 容灾，高可用怎么做的

下文中有业务可用性的实践，这里讲一下系统可用性，容灾的方案

1. 服务限流： 根据压测结果做了登录态校验的接口的限流（sentinel），降级之后会给到一个特殊的code. 我们提供出去给getway的sdk中会识别这个code. 走降级逻辑。
2. 服务的 内存，cpu达到 85+ 左右的时候，运维系统会给机器做自动扩容，同时发出告警消息和电话，通知服务负责人

# 遇到了哪些问题

要在反解验证合法性的基础上，增加价差token是否是我们系统发放出去的检查，需要使用到存储的检查。同时还得保证性能耗时得要求。并且因为引入了这个逻辑，还得考虑在做这块逻辑出现问题得时候的熔断降级方案：这就需要梳理该业务功能的全链路，并对链路上的可能发生故障的节点做分析，当他们发生故障的时候我的该业务功能是否还可以用，有什么降级方案能保证它可用/基本可用。

关于性能这块，我们使用了 local cache + redis 的策略，这样能够有效的较低对redis的压力，不需要很大的redis集群就可以完成需求。

local cache 使用 LRU的淘汰策略，可以和好的保证我们的一个 缓存命中率，实践中发现97%都会走到缓存。然后菜刀 redis

这样很好的保证了整体的性能做到了一个低耗时。



**业务可用性这块下文中有详细的描述。**



# 如何做到支持新应用快速接入提升其开发效率

为了能够支持多应用的快速开发。通过在请求头中约定app标识。服务中解析并通过配置可以快速识别应用所属账号体系（同一体系下的账号uid相同。）并对所有登录注册接口做底层适配，同意登录注册的底层入口使用统一的解析逻辑进行处理，确保几乎所有账号的登录注册接口可复用。确保可以做到新应用的快速对接适配。由于服务的配置是动态的。服务也无需发布只需修改配置让其生效即可（未配置的应用的请求会被拦截可避免脏数据）

# 登录态token的发放/检查如果做到业务可用性9999

## 登录态检查

**登录态检查主要是分为**

1. 合法性检查：
   1. 通过对称密钥解析token 检查是否合法
   2. 通过存储(redis, 本地缓存，db)检查token是否是系统发放（避免密钥泄露外部伪造）
2. 有效性检查
   1. 登录态的**有效期**，加密在token中，可以通过解析获取过期时间。然后用其检查即可
   2. 在系统存储中获取token对应的有效性, 有效性检查主要是因为账号可能被处罚（账号冻结，踢出登录态（账号再次登录的拦截功能会有风控负责拦截......））

**如何保证该功能9999 的可用性指标?**

先看一下整个调用链路：用户client -> 阿里云 -> 内部GetWay -> token管理服务

在不考虑 用户网络问题的前提: 我们只需要考虑 后续链路的可用性： 阿里云对外提供的数据是他们提供 9999 的可用性。公司内部getWay 中间件保证提供9999 的服务。所以我只要保证我的登录态校验概率是9999以上即可

基于此：我们开发了token的校验sdk , getWay 直接使用该sdk对登录态进行校验，内部逻辑是：

1. 调用 token服务

   1. 解析token检查是否合法，检查其是否在有效期内，如不合法，不在有效期则立即**返回无效**

   2. 如果合法。检查在本地缓存中是否存在，如过存在**返回有效**

   3. 如不存在检查 redis中是否存在。如存在将其放入本地缓存**返回有效**

   4. 如 redis不存在则查询 db 通过 token中解析出来的uid ,app 等信息通过索引uid 从db中获取token信息。该数据在db中是唯一的

      如果数据存在则根据有效期存储redis并设置过期时间。并存入本地缓存并设置过期时间。**返回有效**

      如不存在则**返回无效**

   **在这其中涉及到外部访问的有 redis 以及 DB. 这里都通过 sentinel做了 访问错误/超时的熔断配置。如果被熔断就走降级逻辑。使用第一步中 解析token的结果作为返回结果。** 

2. 调用 token服务失败/超时走降级逻辑，并且也通过 sentinel 做了熔断配置

   降级逻辑：通过解析token 并判断 token解析出来的有效期判断 token是否合法有效

## 登录态发放

**如何保证该功能9999 的可用性指标?**

先看一下整个调用链路：用户client -> 阿里云 -> 内部GetWay -> 账号服务 -> token管理服务

在不考虑 用户网络问题的前提: 我们只需要考虑 后续链路的可用性： 阿里云对外提供的数据是他们提供 9999 的可用性。公司内部getWay 中间件保证提供9999 的服务。所以我只要保证账号服务和发放登录态的业务成功的概率是9999以上即可

首先看账号服内部的处理逻辑是： 

1. 将手机号，app信息等发送到 风控等待风控
2. 如果风控未拦截，则进入后续的账号注册/登录环节
   1. 访问DB 检查/注册信息
   2. 调用token服务获取token

这里就会遇到一些问题。如果我调用 1.风控服务失败怎么办？2.如果调用 db失败怎么办？3.如果调用token服务获取token失败怎么办？4. 如果账号服务全部网络不可用怎么办？

**其中问题一调用风控服务失败怎么办？**

 采取的策略是不阻断流程，继续执行后续逻辑。这样风控服务的异常问题对我们登陆注册核心服务就不会产生影响，就算后续账号有问题风控服务也可采取他措施（账号冻结等手段处理）。并且我们还通过 sentinel 组件对其作了熔断降级: 当其失败次数过多/超时频繁 也会熔断。

**问题二 调用DB失败怎么办？**

这里无法处理, 因为要启用备用库什么多会增加程序的复杂性。不过因为阿里云保证其可用性在 9999 所以不会对整体可用性有太大影响

**问题三： 调用token服务获取token失败怎么办? **

这里我们未token服务开发了登录态发放的sdk. 内部逻辑包括

1. 调用 token服务获取token. 如果失败重试一次。再次失败则启动本地token生成逻辑。
2. 其次 对token服务的调用也使用了sentinel ， 失败次数过多/超时严重都会熔断降级：走本地token生成逻辑

这里还需要特别说明一下本地token生成逻辑： 会通过对称密钥生成一个有效时常2小时以内（正常发放的token有效期都是半个月）。

配合client端的 token续期（使用老token置换新token）的功能保证用户使用体验。

**问题四： 如果账号服务全部网络不可用怎么办？**

为了避免因为区域性机房网络不可用，我们在部署的时候特别要求了两个机房分别对半部署服务器

其次机器 cpu 使用过高， OOM 等会有电话+信息预警+开发可对机器做扩容，重启，回滚等操作。可以保证对事件的及时处理。

# 演练涉及到 登录态校验。登录注册

登录态校验主要是涉及到各app的各端，登录后的用户的访问。会将梳理中可能发生问题的故障点，通过阿里云的混沌工程认为造成故障。模拟其发生故障的时候业务是否正常工作。比如登录态校验我们就会 模拟token服务故障，看token校验的sdk是否正常用作保证用户请求正常走到业务下游得到处理，而不是在登录态校验处被拦截。比如 模拟 token服务内部访问的 redis的超时/异常....

当然这些都通过整理成文档交给QA进行处理。然后再通过其报告判断常态化演练中是否还有其他问题需要优化。



登录注册这块 主要是是涉及到登录态发放。风控业务的熔断是否生效。 微信登录多用户失败过多是否可以提醒用户使用其他登陆方式。多手机号短信登录失败是否可以提示其使用其他方式。是否提供了兜底的密码登录。密码登录是否可用等。





